name: Deploy to Webspace (SFTP)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore Workloads
        run: dotnet workload restore BKBToolClient.csproj

      - name: Restore
        run: dotnet restore BKBToolClient.csproj

      - name: Publish Release
        run: dotnet publish BKBToolClient.csproj -c Release -o dist

      - name: List publish output
        run: |
          echo "Contents of dist/"
          ls -la dist || true
          echo "Contents of dist/wwwroot/"
          ls -la dist/wwwroot || true

      - name: Deploy via SFTP with lftp
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_REMOTE_PATH: ${{ secrets.SFTP_REMOTE_PATH }}
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp
          if [ ! -d dist/wwwroot ]; then
            echo "dist/wwwroot not found. Publish step may have failed."
            exit 1
          fi
          lftp -c "
          set sftp:auto-confirm yes;
          open sftp://${SFTP_USER}:${SFTP_PASSWORD}@${SFTP_HOST}:${SFTP_PORT};
          cd ${SFTP_REMOTE_PATH};
          lcd dist/wwwroot;
          mirror -R --delete --verbose ./ ./;
          bye
          "
